{
  "session": "database-setup",
  "description": "Set up SQLite database for local development and seed with real electricity contract data",
  "tasks": [
    {
      "id": "configure-sqlite",
      "title": "Configure Laravel for SQLite local development",
      "description": "Update .env to use SQLite database instead of PostgreSQL. Change DB_CONNECTION to sqlite, set DB_DATABASE to full path of database/database.sqlite. Update SESSION_DRIVER, CACHE_STORE, and QUEUE_CONNECTION to file-based drivers since they currently use database. Run php artisan config:clear after changes.",
      "status": "completed",
      "priority": 1,
      "completed_at": "2026-01-19T20:15:00Z",
      "passes": true
    },
    {
      "id": "create-postcode-seeder",
      "title": "Create PostcodeSeeder with real Finnish postcode data",
      "description": "Create a PostcodeSeeder that fetches real Finnish postcode data from Posti.fi API (https://www.posti.fi/webpcode/unzip/). Parse the PCF_*.dat file using the fixed-width format: PONOT + date(8) + postcode(5) + postcode_fi_name(30) + postcode_sv_name(30) + abbr_fi(12) + abbr_sv(12) + valid_from(8) + type_code(1) + ad_area_code(5) + ad_area_fi(30) + ad_area_sv(30) + municipal_code(3) + municipal_name_fi(20) + municipal_name_sv(20) + language_ratio_code(1). Generate slugs for name fields. Insert into postcodes table. Reference the Python implementation at legacy/python/shared/voltikka/utils/postcodes.py.",
      "status": "completed",
      "priority": 2,
      "completed_at": "2026-01-19T20:18:00Z",
      "passes": true
    },
    {
      "id": "run-migrations",
      "title": "Run database migrations",
      "description": "Run php artisan migrate:fresh to create all tables in SQLite database. Verify all migrations complete successfully.",
      "status": "completed",
      "priority": 3,
      "depends_on": ["configure-sqlite"],
      "completed_at": "2026-01-19T20:20:00Z",
      "passes": true
    },
    {
      "id": "seed-postcodes",
      "title": "Seed postcodes from Posti.fi",
      "description": "Run php artisan db:seed --class=PostcodeSeeder to populate the postcodes table with real Finnish postcode data.",
      "status": "completed",
      "priority": 4,
      "depends_on": ["run-migrations", "create-postcode-seeder"],
      "completed_at": "2026-01-19T20:22:00Z",
      "passes": true
    },
    {
      "id": "fetch-contracts",
      "title": "Fetch electricity contracts from Azure API",
      "description": "Run php artisan contracts:fetch to fetch real electricity contracts from the Azure Consumer API. This will populate companies, electricity_contracts, price_components, electricity_sources, and contract_postcode tables with real data. Verify the command completes successfully with data.",
      "status": "completed",
      "priority": 5,
      "depends_on": ["seed-postcodes"],
      "completed_at": "2026-01-19T20:25:00Z",
      "passes": true
    },
    {
      "id": "verify-data",
      "title": "Verify database has contract data",
      "description": "Use php artisan tinker to verify: 1) Postcodes table has ~3000+ records, 2) Companies table has records, 3) ElectricityContract table has records, 4) PriceComponent table has records. Print counts for each table.",
      "status": "completed",
      "priority": 6,
      "depends_on": ["fetch-contracts"],
      "completed_at": "2026-01-19T20:28:00Z",
      "passes": true,
      "notes": "Data verified: Postcodes=3786, Companies=37, ElectricityContracts=488, ElectricitySources=488, ActiveContracts=488. PriceComponents=1 (expected 1173). Low count due to Azure API returning null UUIDs for most price component IDs."
    },
    {
      "id": "fix-price-components",
      "title": "Fix PriceComponent insertion with null UUIDs",
      "description": "The Azure API returns null UUIDs (00000000-0000-0000-0000-000000000000) for most price component IDs, causing composite key conflicts with insertOrIgnore. Fix the FetchContracts command at laravel/app/Console/Commands/FetchContracts.php to generate unique IDs for price components when the API returns a null UUID. Use Str::uuid() to generate a unique ID in the processPriceComponents method when $component['Id'] is a null UUID. After fixing, re-run contracts:fetch and verify PriceComponent count is ~1000+. Write tests first following TDD.",
      "status": "completed",
      "priority": 7,
      "depends_on": ["verify-data"],
      "completed_at": "2026-01-19T21:00:00Z",
      "passes": true,
      "notes": "Fixed by generating new UUIDs for null/zero UUIDs. Now have 1173 price components."
    },
    {
      "id": "fix-memory-exhaustion",
      "title": "Fix memory exhaustion on contracts list page",
      "description": "The ContractsList Livewire component at laravel/app/Livewire/ContractsList.php is causing memory exhaustion (128MB limit exceeded) when loading the page. The issue is in getContractsProperty() which loads ALL 488 contracts with their relationships (priceComponents, company, electricitySource, availabilityPostcodes) at once. FIX: 1) Don't eager load availabilityPostcodes - it has 7000+ pivot records. Instead check availability using exists query or load lazily. 2) Only load the latest price component per type using a subquery or by filtering in PHP after limiting results. 3) Consider limiting results initially and using 'load more' or pagination. Write tests first following TDD.",
      "status": "completed",
      "priority": 8,
      "depends_on": ["fix-price-components"],
      "completed_at": "2026-01-19T21:45:00Z",
      "passes": true,
      "notes": "Fixed by removing availabilityPostcodes from eager loading and applying postcode filter at database level using EXISTS subquery. Memory usage reduced from >128MB to ~12MB. All 126 tests pass."
    }
  ]
}
